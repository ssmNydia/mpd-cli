#!/usr/bin/env node
const fs = require('fs')
const path = require('path')
const util = require('../lib/util')
const cli = require('../lib/cli')
const start = require('../lib/start')

cli.info('正在启动...')

cli.setup({
  noArgs: true,
  options: [
    ['-p, --port <n>', '启动端口号', parseInt],
    ['-d, --dir <value>', '项目文件夹路径'],
    ['-o, --autoopen <value>', '自动打开网页'],
    ['-rc, --routerconfig <value>', 'mpd-cli 配置路由文件路径']
  ],
  help: [
    '',
    '  Examples:',
    cli.chalk.gray('    # 启动测试服务器'),
    '    $ mpd serve'
  ].join('\n')
})

const cfpath = path.resolve(process.cwd(), cli.program.config || 'mpd.config.js')
const rpath = path.resolve(process.cwd(), cli.program.routerconfig || 'router.js')
let defconf = {}

if(fs.existsSync(cfpath)){
  defconf = require(cfpath)
}

const conf = Object.assign(
  defconf.isH5 || {isH5: false},
  defconf.lessTheme || {},
  defconf.dev || {},
  defconf.plugins || {},
  util.subObject(cli.program,['port','dir','livereload','static','autoopen','mobile','openProxy']),
  {cliConfPath: cfpath, cliRtPath: rpath}
)

start(conf)